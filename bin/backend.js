#!/usr/bin/env node
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
require("source-map-support/register");
const cdk = require("aws-cdk-lib");
const neptune_network_stack_1 = require("../lib/neptune-network-stack");
const api_stack_1 = require("../lib/api-stack");
const waf_stack_1 = require("../lib/waf-stack");
const cdk_nag_1 = require("cdk-nag");
const config_1 = require("../config");
const NagLogger_1 = require("../nag/NagLogger");
const app = new cdk.App();
const logger = new NagLogger_1.NagLogger();
cdk.Aspects.of(app).add(new cdk_nag_1.AwsSolutionsChecks({ verbose: true, additionalLoggers: [logger] }));
const appName = config_1.deployConfig.appName || "graphApp";
const env = {
    account: process.env.CDK_DEFAULT_ACCOUNT || process.env.AWS_ACCOUNT_ID,
    region: config_1.deployConfig.region || process.env.CDK_DEFAULT_REGION,
};
const neptuneNetwork = new neptune_network_stack_1.NeptuneNetworkStack(app, `${appName}-NeptuneNetworkStack`, {
    natSubnet: false,
    maxAz: 2,
    neptuneServerlss: true,
    neptuneServerlssCapacity: {
        minCapacity: 1,
        maxCapacity: 2.5,
    },
    // Stop Neptune 12am–4pm Pacific to save costs
    neptuneSchedule: {
        enabled: true,
        timezone: "America/Los_Angeles",
        stopHour: 0, // midnight Pacific — cluster stops
        startHour: 16, // 4pm Pacific — cluster starts
    },
    env,
});
new api_stack_1.ApiStack(app, `${appName}-ApiStack`, {
    cognito: {
        adminEmail: config_1.deployConfig.adminEmail,
    },
    vpc: neptuneNetwork.vpc,
    cluster: neptuneNetwork.cluster,
    clusterRole: neptuneNetwork.neptuneRole,
    graphqlFieldName: ["getGraph", "getProfile", "getRelationName", "insertData", "askGraph"],
    s3Uri: config_1.deployConfig.s3Uri,
    env,
});
new waf_stack_1.WafCloudFrontStack(app, `${appName}-WafStack`, {
    allowedIps: config_1.deployConfig.allowedIps,
    wafParamName: config_1.deployConfig.wafParamName,
    env: {
        ...env,
        region: "us-east-1",
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFja2VuZC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImJhY2tlbmQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsdUNBQXFDO0FBQ3JDLG1DQUFtQztBQUNuQyx3RUFBbUU7QUFDbkUsZ0RBQTRDO0FBQzVDLGdEQUFzRDtBQUN0RCxxQ0FBNkM7QUFFN0Msc0NBQXlDO0FBQ3pDLGdEQUE2QztBQUU3QyxNQUFNLEdBQUcsR0FBRyxJQUFJLEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQztBQUMxQixNQUFNLE1BQU0sR0FBRyxJQUFJLHFCQUFTLEVBQUUsQ0FBQztBQUUvQixHQUFHLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQ3JCLElBQUksNEJBQWtCLENBQUMsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLGlCQUFpQixFQUFFLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUN2RSxDQUFDO0FBRUYsTUFBTSxPQUFPLEdBQUcscUJBQVksQ0FBQyxPQUFPLElBQUksVUFBVSxDQUFDO0FBQ25ELE1BQU0sR0FBRyxHQUFHO0lBQ1YsT0FBTyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsbUJBQW1CLElBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjO0lBQ3RFLE1BQU0sRUFBRSxxQkFBWSxDQUFDLE1BQU0sSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLGtCQUFrQjtDQUM5RCxDQUFDO0FBQ0YsTUFBTSxjQUFjLEdBQUcsSUFBSSwyQ0FBbUIsQ0FDNUMsR0FBRyxFQUNILEdBQUcsT0FBTyxzQkFBc0IsRUFDaEM7SUFDRSxTQUFTLEVBQUUsS0FBSztJQUNoQixLQUFLLEVBQUUsQ0FBQztJQUNSLGdCQUFnQixFQUFFLElBQUk7SUFDdEIsd0JBQXdCLEVBQUU7UUFDeEIsV0FBVyxFQUFFLENBQUM7UUFDZCxXQUFXLEVBQUUsR0FBRztLQUNqQjtJQUNELDhDQUE4QztJQUM5QyxlQUFlLEVBQUU7UUFDZixPQUFPLEVBQUUsSUFBSTtRQUNiLFFBQVEsRUFBRSxxQkFBcUI7UUFDL0IsUUFBUSxFQUFFLENBQUMsRUFBSSxtQ0FBbUM7UUFDbEQsU0FBUyxFQUFFLEVBQUUsRUFBRywrQkFBK0I7S0FDaEQ7SUFDRCxHQUFHO0NBQ0osQ0FDRixDQUFDO0FBRUYsSUFBSSxvQkFBUSxDQUFDLEdBQUcsRUFBRSxHQUFHLE9BQU8sV0FBVyxFQUFFO0lBQ3ZDLE9BQU8sRUFBRTtRQUNQLFVBQVUsRUFBRSxxQkFBWSxDQUFDLFVBQVU7S0FDcEM7SUFDRCxHQUFHLEVBQUUsY0FBYyxDQUFDLEdBQUc7SUFDdkIsT0FBTyxFQUFFLGNBQWMsQ0FBQyxPQUFPO0lBQy9CLFdBQVcsRUFBRSxjQUFjLENBQUMsV0FBVztJQUN2QyxnQkFBZ0IsRUFBRSxDQUFDLFVBQVUsRUFBRSxZQUFZLEVBQUUsaUJBQWlCLEVBQUUsWUFBWSxFQUFFLFVBQVUsQ0FBQztJQUN6RixLQUFLLEVBQUUscUJBQVksQ0FBQyxLQUFLO0lBQ3pCLEdBQUc7Q0FDSixDQUFDLENBQUM7QUFFSCxJQUFJLDhCQUFrQixDQUFDLEdBQUcsRUFBRSxHQUFHLE9BQU8sV0FBVyxFQUFFO0lBQ2pELFVBQVUsRUFBRSxxQkFBWSxDQUFDLFVBQVU7SUFDbkMsWUFBWSxFQUFFLHFCQUFZLENBQUMsWUFBWTtJQUN2QyxHQUFHLEVBQUU7UUFDSCxHQUFHLEdBQUc7UUFDTixNQUFNLEVBQUUsV0FBVztLQUNwQjtDQUNGLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIiMhL3Vzci9iaW4vZW52IG5vZGVcbmltcG9ydCBcInNvdXJjZS1tYXAtc3VwcG9ydC9yZWdpc3RlclwiO1xuaW1wb3J0ICogYXMgY2RrIGZyb20gXCJhd3MtY2RrLWxpYlwiO1xuaW1wb3J0IHsgTmVwdHVuZU5ldHdvcmtTdGFjayB9IGZyb20gXCIuLi9saWIvbmVwdHVuZS1uZXR3b3JrLXN0YWNrXCI7XG5pbXBvcnQgeyBBcGlTdGFjayB9IGZyb20gXCIuLi9saWIvYXBpLXN0YWNrXCI7XG5pbXBvcnQgeyBXYWZDbG91ZEZyb250U3RhY2sgfSBmcm9tIFwiLi4vbGliL3dhZi1zdGFja1wiO1xuaW1wb3J0IHsgQXdzU29sdXRpb25zQ2hlY2tzIH0gZnJvbSBcImNkay1uYWdcIjtcblxuaW1wb3J0IHsgZGVwbG95Q29uZmlnIH0gZnJvbSBcIi4uL2NvbmZpZ1wiO1xuaW1wb3J0IHsgTmFnTG9nZ2VyIH0gZnJvbSBcIi4uL25hZy9OYWdMb2dnZXJcIjtcblxuY29uc3QgYXBwID0gbmV3IGNkay5BcHAoKTtcbmNvbnN0IGxvZ2dlciA9IG5ldyBOYWdMb2dnZXIoKTtcblxuY2RrLkFzcGVjdHMub2YoYXBwKS5hZGQoXG4gIG5ldyBBd3NTb2x1dGlvbnNDaGVja3MoeyB2ZXJib3NlOiB0cnVlLCBhZGRpdGlvbmFsTG9nZ2VyczogW2xvZ2dlcl0gfSlcbik7XG5cbmNvbnN0IGFwcE5hbWUgPSBkZXBsb3lDb25maWcuYXBwTmFtZSB8fCBcImdyYXBoQXBwXCI7XG5jb25zdCBlbnYgPSB7XG4gIGFjY291bnQ6IHByb2Nlc3MuZW52LkNES19ERUZBVUxUX0FDQ09VTlQgfHwgcHJvY2Vzcy5lbnYuQVdTX0FDQ09VTlRfSUQsXG4gIHJlZ2lvbjogZGVwbG95Q29uZmlnLnJlZ2lvbiB8fCBwcm9jZXNzLmVudi5DREtfREVGQVVMVF9SRUdJT04sXG59O1xuY29uc3QgbmVwdHVuZU5ldHdvcmsgPSBuZXcgTmVwdHVuZU5ldHdvcmtTdGFjayhcbiAgYXBwLFxuICBgJHthcHBOYW1lfS1OZXB0dW5lTmV0d29ya1N0YWNrYCxcbiAge1xuICAgIG5hdFN1Ym5ldDogZmFsc2UsXG4gICAgbWF4QXo6IDIsXG4gICAgbmVwdHVuZVNlcnZlcmxzczogdHJ1ZSxcbiAgICBuZXB0dW5lU2VydmVybHNzQ2FwYWNpdHk6IHtcbiAgICAgIG1pbkNhcGFjaXR5OiAxLFxuICAgICAgbWF4Q2FwYWNpdHk6IDIuNSxcbiAgICB9LFxuICAgIC8vIFN0b3AgTmVwdHVuZSAxMmFt4oCTNHBtIFBhY2lmaWMgdG8gc2F2ZSBjb3N0c1xuICAgIG5lcHR1bmVTY2hlZHVsZToge1xuICAgICAgZW5hYmxlZDogdHJ1ZSxcbiAgICAgIHRpbWV6b25lOiBcIkFtZXJpY2EvTG9zX0FuZ2VsZXNcIixcbiAgICAgIHN0b3BIb3VyOiAwLCAgIC8vIG1pZG5pZ2h0IFBhY2lmaWMg4oCUIGNsdXN0ZXIgc3RvcHNcbiAgICAgIHN0YXJ0SG91cjogMTYsICAvLyA0cG0gUGFjaWZpYyDigJQgY2x1c3RlciBzdGFydHNcbiAgICB9LFxuICAgIGVudixcbiAgfVxuKTtcblxubmV3IEFwaVN0YWNrKGFwcCwgYCR7YXBwTmFtZX0tQXBpU3RhY2tgLCB7XG4gIGNvZ25pdG86IHtcbiAgICBhZG1pbkVtYWlsOiBkZXBsb3lDb25maWcuYWRtaW5FbWFpbCxcbiAgfSxcbiAgdnBjOiBuZXB0dW5lTmV0d29yay52cGMsXG4gIGNsdXN0ZXI6IG5lcHR1bmVOZXR3b3JrLmNsdXN0ZXIsXG4gIGNsdXN0ZXJSb2xlOiBuZXB0dW5lTmV0d29yay5uZXB0dW5lUm9sZSxcbiAgZ3JhcGhxbEZpZWxkTmFtZTogW1wiZ2V0R3JhcGhcIiwgXCJnZXRQcm9maWxlXCIsIFwiZ2V0UmVsYXRpb25OYW1lXCIsIFwiaW5zZXJ0RGF0YVwiLCBcImFza0dyYXBoXCJdLFxuICBzM1VyaTogZGVwbG95Q29uZmlnLnMzVXJpLFxuICBlbnYsXG59KTtcblxubmV3IFdhZkNsb3VkRnJvbnRTdGFjayhhcHAsIGAke2FwcE5hbWV9LVdhZlN0YWNrYCwge1xuICBhbGxvd2VkSXBzOiBkZXBsb3lDb25maWcuYWxsb3dlZElwcyxcbiAgd2FmUGFyYW1OYW1lOiBkZXBsb3lDb25maWcud2FmUGFyYW1OYW1lLFxuICBlbnY6IHtcbiAgICAuLi5lbnYsXG4gICAgcmVnaW9uOiBcInVzLWVhc3QtMVwiLFxuICB9LFxufSk7XG4iXX0=